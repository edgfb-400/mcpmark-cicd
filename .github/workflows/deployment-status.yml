name: Deployment Status
on:
  push:
    branches:
      - main

jobs:
  pre-deployment:
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.create-issue.outputs.issue_number }}
      previous_sha: ${{ steps.capture.outputs.previous_sha }}
      package_version: ${{ steps.capture.outputs.package_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run lint
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Capture previous commit and package version
        id: capture
        run: |
          echo "previous_sha=${{ github.event.before }}" >> $GITHUB_OUTPUT
          echo "package_version=$(cat package.json | jq -r .version)" >> $GITHUB_OUTPUT

      - name: Create deployment tracking issue
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issue } = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment Tracking - ${context.sha}`,
              labels: ['deployment', 'in-progress'],
              body: `Deployment initiated for commit ${context.sha}`
            });
            core.setOutput('issue_number', issue.number);

      - name: Post pre-deployment completion comment
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.create-issue.outputs.issue_number }},
              body: "Pre-deployment checks completed"
            });

  rollback-preparation:
    needs: pre-deployment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Create rollback artifacts directory
        run: mkdir -p rollback-artifacts

      - name: Create rollback script with error handling
        run: |
          cat > rollback-artifacts/rollback.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail

          PREVIOUS_SHA="$1"
          if [ -z "$PREVIOUS_SHA" ]; then
            echo "ERROR: Previous commit SHA not provided" >&2
            exit 1
          fi

          echo "ðŸ”„ Initiating rollback to commit: $PREVIOUS_SHA"
          
          # Checkout previous commit
          git checkout "$PREVIOUS_SHA"
          
          # Restore configuration backups
          if [ -d "backups" ]; then
            echo "ðŸ“¦ Restoring configuration backups..."
            cp backups/package.json.bak package.json
            cp backups/package-lock.json.bak package-lock.json
            [ -f backups/.env.example.bak ] && cp backups/.env.example.bak .env.example
          fi
          
          # Verify dependencies
          echo "ðŸ” Verifying dependencies..."
          npm ci
          
          echo "âœ… Rollback completed successfully"
          EOF
          chmod +x rollback-artifacts/rollback.sh

      - name: Create configuration backups
        run: |
          mkdir -p rollback-artifacts/backups
          cp package.json rollback-artifacts/backups/package.json.bak
          cp package-lock.json rollback-artifacts/backups/package-lock.json.bak
          [ -f .env.example ] && cp .env.example rollback-artifacts/backups/.env.example.bak

      - name: Create dependency verification script
        run: |
          cat > rollback-artifacts/verify-deps.sh << 'EOF'
          #!/bin/bash
          set -euo pipefail

          echo "ðŸ” Running dependency compatibility check..."
          npm ls
          if [ $? -ne 0 ]; then
            echo "âš ï¸  Dependency issues detected - review the output above"
          else
            echo "âœ… Dependencies are compatible"
          fi
          EOF
          chmod +x rollback-artifacts/verify-deps.sh

      - name: Create rollback documentation
        run: |
          cat > rollback-artifacts/ROLLBACK.md << 'EOF'
          # Rollback Instructions
          
          ## Quick Rollback (One Command)
          ```bash
          ./rollback.sh ${{ needs.pre-deployment.outputs.previous_sha }}
          ```
          
          ## Step-by-Step Rollback
          1. **Checkout Previous Commit**: The script will checkout the previous commit: `${{ needs.pre-deployment.outputs.previous_sha }}`
          2. **Restore Backups**: Configuration files (package.json, package-lock.json, .env.example) will be restored from backups
          3. **Verify Dependencies**: The script will run `npm ci` to ensure correct dependency versions
          4. **Complete Rollback**: The script will confirm successful rollback
          
          ## Artifact Components
          - ðŸ“œ Rollback Script: `rollback.sh` (executable)
          - ðŸ“¦ Configuration Backups: `backups/` directory
          - ðŸ” Dependency Verifier: `verify-deps.sh`
          - ðŸ“š Documentation: `ROLLBACK.md`
          - ðŸ—œï¸  Compressed Package: `rollback-package-${{ github.sha }}.tar.gz`
          - ðŸ” SHA256 Checksum: `rollback-package-${{ github.sha }}.tar.gz.sha256`
          EOF

      - name: Create compressed rollback package and checksum
        run: |
          # Create compressed package
          tar -czf rollback-package-${{ github.sha }}.tar.gz rollback-artifacts
          # Generate SHA256 checksum
          sha256sum rollback-package-${{ github.sha }}.tar.gz > rollback-package-${{ github.sha }}.tar.gz.sha256
          # Move to artifacts directory
          mv rollback-package-${{ github.sha }}.tar.gz rollback-package-${{ github.sha }}.tar.gz.sha256 rollback-artifacts/

      - name: Upload rollback artifacts (30-day retention)
        uses: actions/upload-artifact@v4
        with:
          name: rollback-package-${{ github.sha }}
          path: rollback-artifacts/
          retention-days: 30

      - name: Get SHA256 checksum value
        id: get-checksum
        run: |
          echo "checksum=$(cat rollback-artifacts/rollback-package-${{ github.sha }}.tar.gz.sha256 | awk '{print $1}')" >> $GITHUB_OUTPUT

      - name: Post rollback plan comment to deployment issue
        uses: actions/github-script@v7
        with:
          script: |
            const previousSha = '${{ needs.pre-deployment.outputs.previous_sha }}';
            const currentSha = context.sha;
            const version = '${{ needs.pre-deployment.outputs.package_version }}';
            const artifactName = `rollback-package-${currentSha}`;
            const checksum = '${{ steps.get-checksum.outputs.checksum }}';
            
            const commentBody = `
            # ðŸ”„ Rollback Plan Ready
            
            âœ… Rollback script created with error handling
            âœ… Configuration backups completed
            âœ… Dependency verification script ready
            âœ… Rollback documentation generated
            âœ… Compressed rollback package with SHA256 checksum created
            
            **Previous Commit**: ${previousSha}
            **Current Commit**: ${currentSha}
            **Package Version**: ${version}
            **Artifact**: ${artifactName}
            
            ## Quick Rollback Command
            \`\`\`bash
            ./rollback.sh ${previousSha}
            \`\`\`
            
            **Rollback script created**: true
            **Configuration backup**: true
            **SHA256**: ${checksum}
            `;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue_number }},
              body: commentBody
            });

  post-deployment:
    needs: rollback-preparation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Update deployment issue labels
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.pre-deployment.outputs.issue_number }};
            // Remove in-progress label
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              name: 'in-progress'
            });
            // Add completed label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['completed']
            });

      - name: Post deployment completion comment
        uses: actions/github-script@v7
        with:
          script: |
            const artifactName = `rollback-package-${context.sha}`;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue_number }},
              body: `Deployment Completed Successfully\n\nRollback artifact: ${artifactName} (available for 30 days in GitHub Actions artifacts)`
            });

      - name: Close deployment tracking issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ needs.pre-deployment.outputs.issue_number }},
              state: 'closed'
            });